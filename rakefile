
require 'rubygems'
require 'rubygems/package'
include FileUtils

MINOR_VERSION = ENV['GO_PIPELINE_LABEL'] || "#{Time.now.tv_sec}"

desc 'Clean temporary files'
task :clean do
  rm FileList['*.gem']
end

desc 'Build Gem'
task :build do
  spec = Gem::Specification.new do |s|
    s.name           = 'autostacker24'
    s.authors        = ['Johannes Mueller', 'Christian Rodemeyer']
    s.email          = %w(jmueller@autoscout24.com crodemeyer@autoscout24.com)
    s.homepage       = 'https://github.com/AutoScout24/autostacker24'
    s.summary        = 'Library for managing AWS CloudFormation stacks'
    s.description    = 'n/a'
    s.license        = 'MIT'
    s.files          = FileList['lib/**/*']
    s.version        = "1.0.#{MINOR_VERSION}"
    s.add_dependency 'aws-sdk', '~> 2.0.pre'
  end
  mv Gem::Package.build(spec), 'gems'

  # help bundler finding the latest version
  gemspec = <<-END
    # This file is only necessary to help Bundler installing directly the newest version from Github directly

    Gem::Specification.new do |s|
      s.name           = 'autostacker24'
      s.version        = "$version$"
      s.add_dependency 'aws-sdk', '~> 2.0.pre'
    end
  END
  File.write('.gemspec', gemspec.sub('$version$', spec.version.to_s))
end

desc 'Install latetst Gem'
task :install do
  source = File.expand_path('./gems')
  puts `gem install autostacker24 -N --user-install --source file://#{source}`
end

task :default => [:clean, :build]

